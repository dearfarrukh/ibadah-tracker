<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ibadah Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>

body{
font-family:-apple-system,BlinkMacSystemFont;
margin:0;
padding:20px;
background:none;
}

#bg{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:url("wallpaper.jpg") center/cover no-repeat;
z-index:-1;
}

.card{
background:rgba(255,255,255,0.6);
backdrop-filter:blur(20px);
padding:18px;
border-radius:22px;
margin-bottom:20px;
}
.task{
display:flex;
align-items:center;
justify-content:space-between;
padding:10px 0;
}
  
</style>
</head>

<body>
<div id="bg"></div>
  
<h1 style="text-align:center;">üìø Ibadah Tracker</h1>

<!-- DATE CARD -->
<div class="card">

<div style="display:flex;align-items:center;gap:10px;">

<button onclick="prevDay()">‚¨ÖÔ∏è</button>

<div style="flex:1;text-align:center;position:relative;">

<div id="displayDate" style="font-weight:600;"></div>
<div id="hijriDate" style="font-size:14px;color:gray;"></div>

<input type="date"
id="datePicker"
onchange="manualPick(this.value)"
style="
position:absolute;
top:0;
left:0;
width:100%;
height:100%;
opacity:0;
cursor:pointer;
z-index:5;
">

</div>

<button onclick="nextDay()">‚û°Ô∏è</button>

</div>
</div>

<!-- TASKS -->
<div class="card">
<h3>üìù Daily Tasks</h3>
<div id="taskContainer"></div>
</div>

<!-- SETTINGS -->
<div class="card">
<h3>‚öôÔ∏è Task Settings</h3>

<select id="actionSelect" onchange="handleAction()">
<option value="">Select Action</option>
<option value="add">‚ûï Add Task</option>
<option value="delete">üóë Delete Task</option>
<option value="rename">‚úèÔ∏è Rename Task</option>
</select>

<div id="actionArea"></div>

<h4>‚òÅÔ∏è iCloud Backup</h4>

<button onclick="exportBackup()" style="width:100%;margin-bottom:10px;">Export</button>

<input type="file" id="restoreFile" onchange="importBackup()" style="display:none;">
<button onclick="document.getElementById('restoreFile').click()" style="width:100%">Restore</button>

</div>

<!-- STREAK -->
<div class="card">
<h3>üî• Prayer Streak</h3>
<p id="streakCount">0 Days</p>
</div>

<script>

let currentDate;
  // üî• ONE TIME RESET (remove after it runs once)
localStorage.removeItem("taskList");

let taskList = JSON.parse(localStorage.getItem("taskList"));
  console.log("INITIAL taskList:", taskList);

if(!Array.isArray(taskList) || taskList.length === 0){

taskList = [
{name:"Fajr",start:0,end:null},
{name:"Dhuhur",start:0,end:null},
{name:"Asr",start:0,end:null},
{name:"Maghrib",start:0,end:null},
{name:"Isha",start:0,end:null},

{name:"Surah Mulk",start:0,end:null},
{name:"Surah Sajdah",start:0,end:null},
{name:"Surah Yaseen",start:0,end:null},
{name:"Surah Rehman",start:0,end:null},
{name:"Surah Taghabun",start:0,end:null},
{name:"Surah Waqiya",start:0,end:null},
{name:"Surah Ikhlas",start:0,end:null},
{name:"Surah Ad Duha to Surah Al Nas",start:0,end:null}
];

localStorage.setItem("taskList", JSON.stringify(taskList));

}


function islamicToday(){
let now=new Date();
let d=new Date(now.getFullYear(),now.getMonth(),now.getDate());
if(now.getHours()<2){d.setDate(d.getDate()-1);}
return d;
}

function formatKey(d){
return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
}

function setDate(d){

currentDate=new Date(d);

document.getElementById("displayDate").innerText=
currentDate.toLocaleDateString('en-US',{
weekday:'long',
year:'numeric',
month:'short',
day:'numeric'
});

let hijri=new Intl.DateTimeFormat('en-TN-u-ca-islamic',{
day:'numeric',
month:'long',
year:'numeric'
}).format(currentDate);

document.getElementById("hijriDate").innerText=hijri;

document.getElementById("datePicker").value=formatKey(currentDate);

loadTasks();
}

function manualPick(value){
let p=value.split("-");
setDate(new Date(p[0],p[1]-1,p[2]));
}

function loadTasks(){
console.log("LOAD TASKS taskList:", taskList);
let dateKey=formatKey(currentDate);
let saved=JSON.parse(localStorage.getItem(dateKey))||{};


let container=document.getElementById("taskContainer");
container.innerHTML="";
  

let key=new Date(currentDate).setHours(0,0,0,0);

taskList.forEach(task=>{
if(key < task.start) return;
if(task.end && key > task.end) return;


let div=document.createElement("div");
div.className="task";

div.innerHTML=`

<div onclick="handleTaskClick('${task.name}')" 
style="flex:1;display:flex;align-items:center;gap:8px;cursor:pointer;min-width:0;"

<span style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
${task.name}
</span>

${isSurah(task.name)?
'<span style="background:#007aff;color:white;padding:2px 6px;border-radius:6px;font-size:10px;margin-left:8px;">PDF</span>'
:''}

</div>

<input type="checkbox"
${saved[task.name]?"checked":""}
onchange="toggleTask('${task.name}',this.checked)">
`;
container.appendChild(div);

});

updateStreak();
}

function toggleTask(task,status){
let key=formatKey(currentDate);
let saved=JSON.parse(localStorage.getItem(key))||{};
saved[task]=status;
localStorage.setItem(key,JSON.stringify(saved));
updateStreak();
}

function prevDay(){
currentDate.setDate(currentDate.getDate()-1);
setDate(currentDate);
}

function nextDay(){
currentDate.setDate(currentDate.getDate()+1);
setDate(currentDate);
}

function updateStreak(){
let streak=0;
let today=islamicToday();
for(let i=0;i<365;i++){
let d=new Date(today);
d.setDate(today.getDate()-i);
let key=formatKey(d);
let saved=JSON.parse(localStorage.getItem(key));
if(saved && Object.values(saved).every(v=>v===true)){streak++;}
else break;
}
document.getElementById("streakCount").innerText=streak+" Days";
}

function handleAction(){

let action=document.getElementById("actionSelect").value;
let area=document.getElementById("actionArea");
area.innerHTML="";

// ADD
if(action==="add"){
area.innerHTML=`
<input id="newTaskName" placeholder="Task Name">
<button onclick="confirmAdd()">Add</button>
`;
}

// DELETE
else if(action==="delete"){

let key=new Date(currentDate).setHours(0,0,0,0);

let activeTasks=taskList.filter(task=>{
return key>=task.start && (!task.end || key<=task.end);
});

let opt=activeTasks.map(t=>`<option>${t.name}</option>`).join("");

area.innerHTML=`
<select id="deleteTaskSelect">${opt}</select>
<button onclick="confirmDelete()">Delete</button>
`;
}

// RENAME
else if(action==="rename"){

let opt=taskList.map(t=>`<option>${t.name}</option>`).join("");

area.innerHTML=`
<select id="renameSelect">${opt}</select>
<input id="renameInput" placeholder="New Name">
<button onclick="confirmRename()">Rename</button>
`;
}

}

function confirmAdd(){

let n=document.getElementById("newTaskName").value.trim();
if(!n) return;

let today=new Date(currentDate).setHours(0,0,0,0);

// üî• remove all old versions of same task
taskList=taskList.filter(task=>task.name!==n);

// üü¢ create fresh single timeline
taskList.push({
name:n,
start:today,
end:null
});

localStorage.setItem("taskList",JSON.stringify(taskList));
loadTasks();

}

function confirmDelete(){

let t=document.getElementById("deleteTaskSelect").value;

let y=new Date(currentDate);
y.setDate(y.getDate()-1);

taskList=taskList.map(task=>{
if(task.name===t){
return {...task,end:new Date(y).setHours(0,0,0,0)};
}
return task;
});

localStorage.setItem("taskList",JSON.stringify(taskList));
loadTasks();

}

function confirmRename(){

let oldName=document.getElementById("renameSelect").value;
let newName=document.getElementById("renameInput").value.trim();

if(!newName) return;

taskList=taskList.map(task=>{
if(task.name===oldName){
return {...task,name:newName};
}
return task;
});

localStorage.setItem("taskList",JSON.stringify(taskList));
loadTasks();

}

function exportBackup(){
let data={taskList,storage:{}};
for(let i=0;i<localStorage.length;i++){
let key=localStorage.key(i);
data.storage[key]=localStorage.getItem(key);
}
let blob=new Blob([JSON.stringify(data)]);
let url=URL.createObjectURL(blob);
let a=document.createElement("a");
a.href=url;
a.download="backup.json";
a.click();
}

function importBackup(){
let file=document.getElementById("restoreFile").files[0];
let r=new FileReader();
r.onload=e=>{
let data=JSON.parse(e.target.result);
localStorage.clear();
for(let k in data.storage){
localStorage.setItem(k,data.storage[k]);
}
location.reload();
};
r.readAsText(file);
}

document.addEventListener("DOMContentLoaded",()=>{
setDate(islamicToday());
});
function isSurah(name){
    return name.includes("Surah");
}
function handleTaskClick(name){

// Special file
if(name==="Surah Ad Duha to Surah Al Nas"){
openPDF("Last 22 Surah.pdf");
return;
}

// Automatic for all other Surahs
if(isSurah(name)){
let file=name.replaceAll(" ","-") + ".pdf";
openPDF(file);
}

}

function openPDF(file){
window.location.assign(file);
}

</script>

  


</body>
</html>
